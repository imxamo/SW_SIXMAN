#include <Arduino.h>
#include "DHT.h"

#define Water_Day_Limit 50
#define Water_Per_Try 20
#define Pump_Cooltime 3
#define HOT 25
#define WET 60
#define DRY 20

#define COOLING_FAN_PIN 33
#define LED_PIN 5

struct tm ntime;

int waterRemain;
int waterCool, beepCool;
int airTemp, airMoist, soilMoist, waterLevel;
int edge;

void setup() {
	configTime(gmtOffset_sec, daylightOffset_sec, ntpServer);
  pinMode(COOLING_FAN_PIN, OUTPUT);
  pinMode(LED_PIN, OUTPUT);

  waterRemain = Water_Day_Limit;
	waterCool = 0, beepCool = 0;
	edge = 61; //0~60분 범위 밖의 값을 사용
}

void loop(){
	getLocalTime(&ntime);

	if (ntime.tm_min != edge && ntime.tm_hour == 0 && ntime.tm_min == 0) {
	 waterRemain = Water_Day_Limit  ;
	}

	if(ntime.tm_min != edge && ntime.tm_min%30 == 0){ // 30분마다
    airTemp = 온도;
		airMoist = 습도;
		soilMoist = 토양 습도;
		waterLevel = 물통 잔량 / 41; // 범위를 0~99로 축소
		waterCool++;
		beepCool++;
	}

	if(waterLevel < 30){
		if(waterCool >= Pump_Cooltime && soilMoist < DRY && waterRemain > 0){
			if waterRemain >= Water_Per_Try){
				pump(상수);
			 waterRemain -= Water_Per_Try;
				waterCool = 0;
			}
			else{
				pump waterRemain);
			 waterRemain = 0;
				waterCool = 0;
			}
		}
	}

	if(waterLevel < 50 && beepCool > 0){
		if(waterLevel < 30) 삐삐삐
		else if(waterLevel < 40) 삐삐
		else  삐
		beepCool = 0;
	}
	
	if(ntime.tm_min != edge && ntime.tm_hour == 6 && ntime.tm_min == 0){
		digitalWrite(LED_PIN, HIGH);
	}

	if(ntime.tm_min != edge && ntime.tm_hour == 22 && ntime.tm_min == 0){
    digitalWrite(LED_PIN, LOW);
	}

  if(digitalRead(COOLING_FAN_PIN) == LOW)){ // 팬이 꺼져있을 때
    if(airTemp >= HOT || airMoist >= WET){ // 덥거나 습할때 
		  digitalWrite(COOLING_FAN_PIN, HIGH);
	  }
  }
  else if(airTemp < HOT || airMoist < WET){
		digitalWrite(COOLING_FAN_PIN, LOW);
	}

	// 사이클 쇼크 만들자리

	edge = ntime.tm_min; //반드시 루프 마지막에 위치
}

void pump(int time){
	펌프 작동
	time초 기다리기
	펌프 중단
}
